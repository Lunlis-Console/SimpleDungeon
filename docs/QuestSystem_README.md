# Расширенная система квестов

## Обзор

Новая система квестов предоставляет мощные возможности для создания сложных заданий с различными типами условий, динамическими диалогами и отслеживанием прогресса.

## Основные компоненты

### 1. Типы условий квестов

- **CollectItemsCondition** - собрать определенное количество предметов
- **KillMonstersCondition** - убить определенное количество монстров
- **VisitLocationCondition** - посетить определенную локацию
- **TalkToNPCCondition** - поговорить с определенным NPC
- **ReachLevelCondition** - достичь определенного уровня

### 2. Состояния квестов

- **NotStarted** - квест не принят
- **InProgress** - квест принят, выполняется
- **ReadyToComplete** - все условия выполнены, можно завершить
- **Completed** - квест завершен
- **Failed** - квест провален (опционально)

### 3. Интеграция с диалогами

Система автоматически управляет диалогами NPC в зависимости от состояния квестов:

- **OfferNodeID** - узел для предложения квеста
- **InProgressNodeID** - узел для квеста в процессе
- **ReadyToCompleteNodeID** - узел для готового к завершению квеста
- **CompletedNodeID** - узел для завершенного квеста

## Использование

### 1. Создание квеста в JsonEditor

1. Откройте JsonEditor
2. Перейдите к разделу "Квесты"
3. Нажмите "Добавить квест"
4. Заполните основную информацию:
   - ID квеста
   - Название
   - Описание
   - Квестодатель (NPC)
5. На вкладке "Условия" добавьте необходимые условия
6. На вкладке "Награды" укажите награды
7. На вкладке "Диалоги" укажите ID узлов диалогов
8. На вкладке "Предварительные условия" добавьте зависимости

### 2. Создание диалогов для квестов

В диалогах NPC используйте действия:
- `StartQuest` - начать квест (параметр: ID квеста)
- `CompleteQuest` - завершить квест (параметр: ID квеста)

Пример диалога:
```json
{
  "id": "quest_1_offer",
  "text": "У меня есть для тебя задание...",
  "responses": [
    {
      "text": "Принимаю!",
      "target": "quest_accepted",
      "actions": [
        {
          "type": "StartQuest",
          "param": "1"
        }
      ]
    }
  ]
}
```

### 3. Загрузка квестов в игру

```csharp
// В GameServices или аналогичном классе
var questManager = new QuestManager(worldRepository, player.QuestLog);
questManager.LoadQuests("Data/quests.json");
```

### 4. Обновление прогресса квестов

Система автоматически обновляет прогресс при событиях:

```csharp
// При убийстве монстра
questManager.OnMonsterKilled(killedMonster, player);

// При разговоре с NPC
questManager.OnNPCTalked(npc, player);

// При смене локации
questManager.OnLocationChanged(player);

// При получении предмета
questManager.OnItemObtained(item, player);
```

## Структура JSON файла квестов

```json
{
  "quests": [
    {
      "id": 1,
      "name": "Первое задание",
      "description": "Краткое описание",
      "detailedDescription": "Подробное описание",
      "questGiverId": 1,
      "conditions": [
        {
          "id": 1,
          "description": "Убить крыс",
          "requiredAmount": 3,
          "currentProgress": 0,
          "monsterID": 1
        }
      ],
      "rewards": {
        "experience": 100,
        "gold": 50,
        "items": [
          {
            "itemId": 1,
            "quantity": 1
          }
        ]
      },
      "prerequisites": [],
      "dialogueNodes": {
        "offer": "quest_1_offer",
        "inProgress": "quest_1_progress",
        "readyToComplete": "quest_1_complete",
        "completed": "quest_1_done"
      }
    }
  ]
}
```

## Преимущества новой системы

1. **Гибкость** - множество типов условий квестов
2. **Автоматизация** - автоматическое отслеживание прогресса
3. **Динамические диалоги** - NPC реагируют на состояние квестов
4. **Визуальный редактор** - удобное создание квестов в JsonEditor
5. **Расширяемость** - легко добавлять новые типы условий
6. **Предварительные условия** - квесты могут зависеть друг от друга

## Интеграция с существующей системой

Новая система полностью совместима со старой системой квестов. Старые квесты продолжают работать, а новые используют расширенные возможности.

## Примеры использования

### Квест "Охота на дракона"
- Условие: убить 1 дракона
- Награда: 1000 опыта, 500 золота, меч драконобойца

### Квест "Сбор трав"
- Условие: собрать 10 лечебных трав
- Предварительное условие: завершить квест "Охота на дракона"
- Награда: 200 опыта, 100 золота

### Квест "Исследование"
- Условие: посетить пещеру дракона
- Условие: поговорить с мудрецом
- Награда: 300 опыта, знание о драконах
