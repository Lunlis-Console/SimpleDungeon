# Система спавна предметов для квестов

## Обзор

Система спавна предметов для квестов позволяет автоматически размещать целевые предметы квестов на выбранных локациях с определенным шансом. Это делает квесты более динамичными и интересными для игроков.

## Основные компоненты

### 1. QuestItemSpawnData

Класс, описывающий параметры спавна предмета на локации:

```csharp
public class QuestItemSpawnData
{
    public int LocationID { get; set; }           // ID локации для спавна
    public int SpawnChance { get; set; }          // Шанс спавна (0-100%)
    public int Quantity { get; set; }            // Количество предметов за спавн
    public int MaxItemsOnLocation { get; set; }   // Максимум предметов на локации
    public int SpawnInterval { get; set; }       // Интервал между попытками спавна
}
```

### 2. CollectItemsCondition

Расширенное условие собирания предметов с поддержкой спавна:

```csharp
public class CollectItemsCondition : QuestCondition
{
    public int ItemID { get; set; }
    public List<QuestItemSpawnData> SpawnLocations { get; set; }
}
```

### 3. QuestItemSpawnManager

Менеджер, управляющий спавном предметов квестов:

- `InitializeQuestItemSpawns()` - инициализирует спавн для активных квестов
- `ProcessQuestItemSpawn()` - обрабатывает спавн для конкретного условия
- `ForceSpawnQuestItems()` - принудительно спавнит предметы
- `CleanupQuestItems()` - очищает предметы при завершении квеста

## Использование в JSON

### Пример квеста с спавном предметов

```json
{
  "id": 1001,
  "name": "Сбор редких трав",
  "description": "Соберите 3 редкие травы",
  "conditions": [
    {
      "id": 1,
      "type": "CollectItems",
      "description": "Собрать редкие травы",
      "requiredAmount": 3,
      "targetId": 1001,
      "spawnLocations": [
        {
          "locationID": 3001,
          "spawnChance": 25,
          "quantity": 1,
          "maxItemsOnLocation": 2,
          "spawnInterval": 3
        },
        {
          "locationID": 3002,
          "spawnChance": 30,
          "quantity": 1,
          "maxItemsOnLocation": 1,
          "spawnInterval": 2
        }
      ]
    }
  ]
}
```

## Параметры спавна

### SpawnChance (Шанс спавна)
- **Диапазон**: 0-100
- **Описание**: Процентная вероятность появления предмета при попытке спавна
- **Примеры**:
  - `25` - 25% шанс спавна
  - `100` - гарантированный спавн
  - `5` - очень редкий спавн

### Quantity (Количество)
- **Описание**: Сколько предметов появляется за один спавн
- **Примеры**:
  - `1` - один предмет
  - `3` - три предмета сразу

### MaxItemsOnLocation (Максимум на локации)
- **Описание**: Максимальное количество предметов этого типа на локации одновременно
- **Примеры**:
  - `1` - только один предмет на локации
  - `5` - до пяти предметов на локации

### SpawnInterval (Интервал спавна)
- **Описание**: Количество игровых циклов между попытками спавна
- **Примеры**:
  - `1` - каждая попытка спавна
  - `3` - каждые три цикла
  - `10` - редкие попытки спавна

## Логика работы

1. **Начало квеста**: При старте квеста предметы принудительно спавнятся на всех указанных локациях (если не превышен лимит)

2. **Периодический спавн**: При каждом обновлении прогресса квестов система проверяет возможность спавна предметов

3. **Проверка условий**: Система проверяет:
   - Интервал спавна (счетчик циклов)
   - Шанс спавна (случайное число)
   - Максимальное количество предметов на локации

4. **Завершение квеста**: При завершении квеста все предметы этого квеста удаляются с локаций

## Интеграция с игрой

Система автоматически интегрирована в существующую архитектуру:

- `QuestManager` управляет спавном через события
- `QuestLog` вызывает спавн при обновлении прогресса
- `QuestItemSpawnManager` обрабатывает логику спавна
- Предметы добавляются в `GroundItems` локаций

## Отладка

Система включает подробное логирование:

```
QuestItemSpawnManager.ProcessQuestItemSpawn: Processing condition 1 for item 1001
QuestItemSpawnManager.SpawnQuestItemOnLocation: Added 1 Редкая трава to location Лес
```

## Примеры использования

### Квест "Сбор минералов"
- Предметы спавнятся в пещерах с шансом 20%
- Максимум 3 минерала на локацию
- Интервал спавна: 5 циклов

### Квест "Охота на редких существ"
- Части существ спавнятся в разных биомах
- Высокий шанс спавна (80%) но длинный интервал (10 циклов)
- Максимум 1 часть на локацию

### Квест "Сбор цветов"
- Цветы спавнятся в садах и полях
- Низкий шанс спавна (10%) но частые попытки (1 цикл)
- Максимум 5 цветов на локацию

